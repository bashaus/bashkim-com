service: bashkim-com

custom:
  stage: "${opt:stage, env:SLS_STAGE, 'production'}"
  region: "${opt:region, env:AWS_DEFAULT_REGION, 'eu-west-1'}"
  website:
    assetBucket: "${env:DEPLOY_S3_ASSET_BUCKET}"
    certificateArn: "arn:aws:acm:us-east-1:409535992503:certificate/a232ee88-ad8e-44c1-a9c2-5a8cdb2e2577"
    domain: www.bashkim.com

provider:
  name: aws
  runtime: nodejs8.10
  stage: ${self:custom.stage}
  region: ${self:custom.region}
  memorySize: 512
  timeout: 15
  environment:
    APP_ENV: production
    GIT_COMMIT: ${env:WERCKER_GIT_COMMIT}
    LAMBDA: true
    NODE_ENV: production

package:
  exclude:
    - .storybook/**
    - "**/stories.jsx"
    - components/**
    - data/**
    - pages/**
    - propTypes/**
    - static/**
    - store/**
    - styleguide/**
    - node_modules/.cache/**
    - .babelrc
    - .editorconfig
    - .eslintrc.json
    - .nvmrc
    - package.json
    - package-lock.json
    - wercker.yml
  include:
    - .next/**

functions:
  app:
    handler: lambda.handler
    events:
      - http:
          method: ANY
          path: /
      - http:
          method: ANY
          path: /{any+}

resources:
  Description: bashkim-com
  Resources:
    AssetBucket:
      Type: AWS::S3::Bucket
      DeletionPolicy: Delete
      Properties:
        BucketName: ${self:custom.website.assetBucket}

    AssetBucketPolicy:
      Type: "AWS::S3::BucketPolicy"
      DependsOn:
        - CloudFrontOriginAccessIdentity
        - AssetBucket
      Properties:
        Bucket: ${self:custom.website.assetBucket}
        PolicyDocument:
          Statement:
            - Action:
              - "s3:GetObject"
              Effect: "Allow"
              Resource:
                Fn::Join:
                  - ""
                  - - Fn::GetAtt: [AssetBucket, Arn]
                    - "/*"
              Principal:
                CanonicalUser:
                  Fn::GetAtt: [CloudFrontOriginAccessIdentity, S3CanonicalUserId]

    CloudFrontOriginAccessIdentity:
      Type: "AWS::CloudFront::CloudFrontOriginAccessIdentity"
      Properties:
        CloudFrontOriginAccessIdentityConfig:
          Comment:
            Fn::Join:
              - ""
              - - Ref: AWS::StackName
                - "-origin-access-identity"

    CloudFrontDistributionWebsite:
      Type: AWS::CloudFront::Distribution
      DependsOn:
        - AssetBucket
      Properties:
        DistributionConfig:
          Aliases:
            - ${self:custom.website.domain}
          PriceClass: PriceClass_100
          ViewerCertificate:
            AcmCertificateArn: ${self:custom.website.certificateArn}
            MinimumProtocolVersion: TLSv1.1_2016
            SslSupportMethod: sni-only
          Origins:
            - DomainName:
                Fn::GetAtt: [AssetBucket, DomainName]
              Id: AssetBucket
              S3OriginConfig:
                OriginAccessIdentity:
                  Fn::Join:
                  - ""
                  - - "origin-access-identity/cloudfront/"
                    - Ref: CloudFrontOriginAccessIdentity
            - DomainName:
                Fn::Join:
                - ""
                - - Ref: ApiGatewayRestApi
                  - ".execute-api."
                  - ${self:custom.region}
                  - ".amazonaws.com"
              Id: APIGWOrigin
              OriginPath: "/${self:custom.stage}"
              CustomOriginConfig:
                OriginKeepaliveTimeout: 60
                OriginReadTimeout: 15
                HTTPPort: 80
                HTTPSPort: 443
                OriginProtocolPolicy: https-only
                OriginSSLProtocols:
                  - 'TLSv1'
                  - 'TLSv1.1'
                  - 'TLSv1.2'
          Enabled: 'true'
          HttpVersion: http2
          CacheBehaviors:
            - PathPattern: /_next/*
              AllowedMethods:
                - GET
                - HEAD
                - OPTIONS
              TargetOriginId: AssetBucket
              Compress: true
              ForwardedValues:
                QueryString: false
              ViewerProtocolPolicy: https-only
            - PathPattern: /static/*
              AllowedMethods:
                - GET
                - HEAD
                - OPTIONS
              TargetOriginId: AssetBucket
              Compress: true
              ForwardedValues:
                QueryString: false
              ViewerProtocolPolicy: https-only
          DefaultCacheBehavior:
            AllowedMethods:
              - GET
              - HEAD
            TargetOriginId: APIGWOrigin
            Compress: true
            MinTTL: 60
            DefaultTTL: 60
            ForwardedValues:
              QueryString: true
              Cookies:
                Forward: none
            ViewerProtocolPolicy: redirect-to-https
