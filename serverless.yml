service: bashkim-com

plugins:
  - serverless-dotenv-plugin
  - serverless-sentry
  - serverless-ignore
  - serverless-jetpack

package:
  individually: true
  exclude:
    - "**/node_modules/aws-sdk/**" # included on Lambda

custom:
  stage: ${opt:stage, env:SLS_STAGE, 'production'}
  region: ${opt:region, env:AWS_DEFAULT_REGION, 'eu-west-1'}
  styleguide: ${self:custom.env.${self:custom.stage}.styleguide}
  website: ${self:custom.env.${self:custom.stage}.website}

  sentry:
    dsn: ${env:SENTRY_DSN, ''}
    environment: ${self:custom.stage}

  jetpack:
    preInclude:
      - "!packages/**"

  ignore:
    file: .slsignore

  env:
    production:
      styleguide:
        certificateArn: "arn:aws:acm:us-east-1:409535992503:certificate/931d3c5c-33c6-410e-a01f-f45176fb0b99"
        domainName: styleguide.bashkim.com
        bucketName: bashkim-com-${self:custom.stage}-styleguide
      website:
        certificateArn: "arn:aws:acm:us-east-1:409535992503:certificate/931d3c5c-33c6-410e-a01f-f45176fb0b99"
        commitHash: ${env:CIRCLE_SHA1, ''}
        domainName: www.bashkim.com
        bucketName: bashkim-com-${self:custom.stage}-website

provider:
  name: aws
  runtime: nodejs14.x
  stage: ${self:custom.stage}
  region: ${self:custom.region}
  memorySize: 512
  timeout: 15
  environment:
    APP_ENV: ${self:custom.stage}
    APP_WEBHOOKS_CIRCLE_API_KEY: ${env:APP_WEBHOOKS_CIRCLE_API_KEY}
    APP_WEBHOOKS_CIRCLE_PROJECT_SLUG: ${env:APP_WEBHOOKS_CIRCLE_PROJECT_SLUG}
    APP_WEBHOOKS_PRISMIC_SECRET_KEY: ${env:APP_WEBHOOKS_PRISMIC_SECRET_KEY}
    GIT_COMMIT: ${self:custom.website.commitHash}
    NODE_ENV: ${self:custom.stage}
    SENTRY_DSN: ${self:custom.sentry.dsn}

functions:
  webhooks:
    handler: packages/webhooks/build/lambda.handler
    jetpack:
      roots:
        - "packages/webhooks"
      preInclude:
        - "packages/webhooks/build/**"
    events:
      - http:
          method: ANY
          path: /webhooks/{any+}
  sitemap:
    handler: packages/sitemap/build/lambda.handler
    jetpack:
      roots:
        - "packages/config"
        - "packages/prismic"
        - "packages/sitemap"
      preInclude:
        - "packages/config/build/**"
        - "packages/prismic/build/**"
        - "packages/sitemap/build/**"
        - "packages/sitemap/public/**"
    events:
      - http:
          method: GET
          path: /robots.txt
      - http:
          method: GET
          path: /sitemap.xml
      - http:
          method: GET
          path: /sitemap/{any+}

resources:
  Description: bashkim-com
  extensions:
    WebhooksLogGroup:
      Properties:
        RetentionInDays: "3"
    SitemapLogGroup:
      Properties:
        RetentionInDays: "3"
